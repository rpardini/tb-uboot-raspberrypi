name: U-Boot for Raspberry Pi Build

on:
  workflow_dispatch:
    inputs:
      uboot_version:
        description: "U-Boot version tag to build"
        required: false
        default: "v2025.10"
        type: string
      rpi_firmware_version:
        description: "Raspberry Pi firmware version"
        required: false
        default: "1.20241008"
        type: string
  push:
    tags:
      - 'v*'

env:
  UBOOT_VERSION: ${{ inputs.uboot_version || 'v2025.10' }}
  UBOOT_DIR: ${{ github.workspace }}/u-boot
  RPI_FIRMWARE_VERSION: ${{ inputs.rpi_firmware_version || '1.20241008' }}
  BASE_BUILD_DIR: ${{ github.workspace }}/build
  BUILD_DIR: ${{ github.workspace }}/build/u-boot-rpi-tb
  FIRMWARE_DIR: ${{ github.workspace }}/firmware
  SRC_DIR: ${{ github.workspace }}/src
  OUT_DIR: ${{ github.workspace }}/out

jobs:

  build-uboot-image:
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          path: src

      - name: Checkout u-boot
        uses: actions/checkout@v4
        with:
          repository: u-boot/u-boot
          fetch-depth: 1
          path: u-boot
          ref: ${{ env.UBOOT_VERSION }}

      - name: Checkout Raspberry Pi firmware
        uses: actions/checkout@v4
        with:
          repository: raspberrypi/firmware
          fetch-depth: 1
          path: firmware
          ref: ${{ env.RPI_FIRMWARE_VERSION }}

      - name: Cache and install build dependencies
        uses: awalsh128/cache-apt-pkgs-action@latest # why?!
        with:
          packages: build-essential git bison flex bc libssl-dev libgnutls28-dev device-tree-compiler dosfstools parted xz-utils
          version: 1.0

      - name: Configure U-Boot for Raspberry Pi 4 ARM64
        working-directory: ${{ env.UBOOT_DIR }}
        run: |
          for f in ${{ env.SRC_DIR }}/patches/*.patch; do
            echo "Applying patch: $f"
            patch -p1 < "$f"
          done

          make rpi_arm64_defconfig

          echo "CONFIG_PREBOOT=\"pci enum; usb start; nvme scan; setenv localcmd 'setenv boot_targets \\\"mmc nvme usb pxe dhcp\\\"; bootflow scan -lb'\"" >> .config

      - name: Build U-Boot
        working-directory: ${{ env.UBOOT_DIR }}
        run: |
          make -j $(nproc) HOSTLDLIBS_mkimage="-lssl -lcrypto"
          ls -la u-boot.bin

      - name: Prepare build directory
        run: |
          mkdir -p ${{ env.BUILD_DIR }}
          mkdir -p ${{ env.OUT_DIR }}

      - name: Prepare boot directory
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          set -x
          
          cp ${{ env.SRC_DIR }}/config.txt .

          # Copy firmware files
          cp -r ${{ env.FIRMWARE_DIR }}/boot/* ./

          # Copy U-Boot binary
          cp ${{ env.UBOOT_DIR }}/u-boot.bin ./
          
          # No kernels please
          rm -rfv ./kernel*
          
          echo "Boot directory contents:"
          ls -lah ./
          
          # Tar up everything in ${{ env.BUILD_DIR }} to  ${{ env.BASE_BUILD_DIR }}/u-boot-rpi-tb.tar.gz
          cd "${{ env.BASE_BUILD_DIR }}"
          tar czf ${{ env.OUT_DIR }}/u-boot-rpi-tb.tar.gz u-boot-rpi-tb


      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Release
          files: |
            out/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

